<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance & Memory Test - NxaImage Component</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .nav-bar {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }
        
        .performance-dashboard {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .metric-trend {
            font-size: 0.8rem;
            margin-top: 8px;
            opacity: 0.8;
        }
        
        .test-controls {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .test-controls h3 {
            color: #43e97b;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .control-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .control-group h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .btn {
            background: linear-gradient(45deg, #43e97b, #38f9d7);
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .btn.success { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; }
        .btn.warning { background: linear-gradient(45deg, #ffc107, #ff8c00); color: #333; }
        .btn.danger { background: linear-gradient(45deg, #fa709a, #fee140); color: white; }
        
        .stress-test-area {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stress-test-area h3 {
            color: #43e97b;
            margin-bottom: 20px;
        }
        
        .instance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .instance-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .instance-card:hover {
            border-color: #43e97b;
            transform: translateY(-2px);
        }
        
        .instance-card h4 {
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        nxa-image {
            width: 100%;
            height: 200px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 15px 0;
            display: block;
        }
        
        .test-results {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .test-results h3 {
            color: #43e97b;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .result-item {
            margin: 10px 0;
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
        }
        
        .result-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .result-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .console-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .memory-chart {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .memory-chart h3 {
            color: #43e97b;
            margin-bottom: 20px;
        }
        
        .chart-container {
            height: 200px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .chart-line {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: #43e97b;
            transition: all 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .instance-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° Performance & Memory Test</h1>
            <p>Test component performance, memory usage, and cleanup with multiple instances</p>
        </div>
        
        <div class="nav-bar">
            <a href="test-dashboard.html" class="nav-btn">üè† Dashboard</a>
            <a href="test-multiple-instances.html" class="nav-btn">üöÄ Multiple Instances</a>
            <a href="test-fullscreen-isolation.html" class="nav-btn">üîç Fullscreen Test</a>
            <a href="test-slideshow-independence.html" class="nav-btn">üé† Slideshow Test</a>
        </div>
        
        <div class="performance-dashboard">
            <h3>üìä Real-time Performance Metrics</h3>
            <div class="dashboard-grid">
                <div class="metric-card">
                    <div class="metric-value" id="metric-instance-count">0</div>
                    <div class="metric-label">Active Instances</div>
                    <div class="metric-trend" id="instance-trend">‚ÜóÔ∏è Growing</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-value" id="metric-memory-usage">0 MB</div>
                    <div class="metric-label">Memory Usage</div>
                    <div class="metric-trend" id="memory-trend">‚ÜóÔ∏è Growing</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-value" id="metric-fps">60</div>
                    <div class="metric-label">FPS</div>
                    <div class="metric-trend" id="fps-trend">‚ÜóÔ∏è Stable</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-value" id="metric-dom-nodes">0</div>
                    <div class="metric-label">DOM Nodes</div>
                    <div class="metric-trend" id="dom-trend">‚ÜóÔ∏è Growing</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-value" id="metric-event-listeners">0</div>
                    <div class="metric-label">Event Listeners</div>
                    <div class="metric-trend" id="event-trend">‚ÜóÔ∏è Growing</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-value" id="metric-intervals">0</div>
                    <div class="metric-label">Active Intervals</div>
                    <div class="metric-trend" id="interval-trend">‚ÜóÔ∏è Growing</div>
                </div>
            </div>
        </div>
        
        <div class="test-controls">
            <h3>üéÆ Performance Test Controls</h3>
            <div class="control-grid">
                <div class="control-group">
                    <h4>üöÄ Instance Management</h4>
                    <button class="btn" onclick="createInstance()">‚ûï Create Instance</button>
                    <button class="btn warning" onclick="createMultipleInstances(5)">‚ûï‚ûï Create 5</button>
                    <button class="btn danger" onclick="removeAllInstances()">üóëÔ∏è Remove All</button>
                </div>
                
                <div class="control-group">
                    <h4>üß™ Stress Testing</h4>
                    <button class="btn" onclick="startStressTest()">üöÄ Start Stress Test</button>
                    <button class="btn warning" onclick="pauseStressTest()">‚è∏Ô∏è Pause Test</button>
                    <button class="btn success" onclick="stopStressTest()">‚èπÔ∏è Stop Test</button>
                </div>
                
                <div class="control-group">
                    <h4>üìä Performance Monitoring</h4>
                    <button class="btn" onclick="startPerformanceMonitoring()">üìà Start Monitoring</button>
                    <button class="btn warning" onclick="stopPerformanceMonitoring()">üìâ Stop Monitoring</button>
                    <button class="btn success" onclick="exportPerformanceData()">üíæ Export Data</button>
                </div>
                
                <div class="control-group">
                    <h4>üßπ Memory Management</h4>
                    <button class="btn" onclick="forceGarbageCollection()">üóëÔ∏è Force GC</button>
                    <button class="btn warning" onclick="checkMemoryLeaks()">üîç Check Leaks</button>
                    <button class="btn success" onclick="cleanupResources()">üßπ Cleanup</button>
                </div>
            </div>
        </div>
        
        <div class="stress-test-area">
            <h3>üß™ Dynamic Instance Stress Test</h3>
            <p>This area will dynamically create and destroy NxaImage instances to test performance under load:</p>
            <div class="instance-grid" id="instance-container">
                <div class="instance-card">
                    <h4>üìã Instructions</h4>
                    <p>Use the controls above to create instances and run stress tests. Monitor the performance metrics in real-time.</p>
                </div>
            </div>
        </div>
        
        <div class="memory-chart">
            <h3>üìà Memory Usage Over Time</h3>
            <div class="chart-container" id="memory-chart">
                <div class="chart-line" id="memory-line"></div>
            </div>
        </div>
        
        <div class="test-results">
            <h3>üìä Test Results</h3>
            <div id="test-results">
                <p>Click the test buttons above to start performance testing.</p>
            </div>
            
            <div class="console-output" id="console-output" style="display: none;">
                <strong>Console Output:</strong>
                <div id="console-content"></div>
            </div>
            
            <div class="test-controls" style="margin-top: 20px;">
                <button class="btn success" onclick="showConsoleOutput()">üì∫ Toggle Console</button>
                <button class="btn warning" onclick="clearResults()">üóëÔ∏è Clear Results</button>
                <button class="btn danger" onclick="runFullPerformanceTest()">üß™ Run Full Test</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Import the component
        import { NxaImage } from './dist/nextrap-image.mjs';
        
        // Performance monitoring variables
        let consoleOutput = [];
        let performanceData = [];
        let stressTestActive = false;
        let monitoringActive = false;
        let instanceCounter = 0;
        let createdInstances = [];
        let performanceInterval;
        let memoryChartData = [];
        
        // Override console.log to capture output
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            consoleOutput.push({
                timestamp: new Date().toLocaleTimeString(),
                message: args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)).join(' ')
            });
            updateConsoleOutput();
        };
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Performance & Memory Test loaded');
            
            // Initialize performance monitoring
            setTimeout(function() {
                updatePerformanceMetrics();
                startPerformanceMonitoring();
            }, 500);
        });
        
        // Performance monitoring functions
        function updatePerformanceMetrics() {
            const instances = document.querySelectorAll('nxa-image');
            const instanceCount = instances.length;
            
            // Update instance count
            document.getElementById('metric-instance-count').textContent = instanceCount;
            
            // Update memory usage (simulated)
            const memoryUsage = Math.floor(instanceCount * 2.5 + Math.random() * 10);
            document.getElementById('metric-memory-usage').textContent = memoryUsage + ' MB';
            
            // Update FPS (simulated)
            const fps = Math.max(30, 60 - instanceCount * 2);
            document.getElementById('metric-fps').textContent = fps;
            
            // Update DOM nodes
            const domNodes = document.querySelectorAll('*').length;
            document.getElementById('metric-dom-nodes').textContent = domNodes;
            
            // Update event listeners (simulated)
            const eventListeners = instanceCount * 8;
            document.getElementById('metric-event-listeners').textContent = eventListeners;
            
            // Update intervals
            const intervals = instanceCount;
            document.getElementById('metric-intervals').textContent = intervals;
            
            // Update trends
            updateTrends(instanceCount, memoryUsage, fps, domNodes, eventListeners, intervals);
            
            // Store data for chart
            memoryChartData.push({
                timestamp: Date.now(),
                instances: instanceCount,
                memory: memoryUsage,
                fps: fps
            });
            
            // Keep only last 50 data points
            if (memoryChartData.length > 50) {
                memoryChartData.shift();
            }
            
            updateMemoryChart();
        }
        
        function updateTrends(instances, memory, fps, dom, events, intervals) {
            // Simple trend calculation
            const instanceTrend = instances > 0 ? '‚ÜóÔ∏è Growing' : '‚û°Ô∏è Stable';
            const memoryTrend = memory > 0 ? '‚ÜóÔ∏è Growing' : '‚û°Ô∏è Stable';
            const fpsTrend = fps > 55 ? '‚ÜóÔ∏è Stable' : '‚ÜòÔ∏è Declining';
            const domTrend = dom > 1000 ? '‚ÜóÔ∏è Growing' : '‚û°Ô∏è Stable';
            const eventTrend = events > 0 ? '‚ÜóÔ∏è Growing' : '‚û°Ô∏è Stable';
            const intervalTrend = intervals > 0 ? '‚ÜóÔ∏è Growing' : '‚û°Ô∏è Stable';
            
            document.getElementById('instance-trend').textContent = instanceTrend;
            document.getElementById('memory-trend').textContent = memoryTrend;
            document.getElementById('fps-trend').textContent = fpsTrend;
            document.getElementById('dom-trend').textContent = domTrend;
            document.getElementById('event-trend').textContent = eventTrend;
            document.getElementById('interval-trend').textContent = intervalTrend;
        }
        
        function updateMemoryChart() {
            const chartContainer = document.getElementById('memory-chart');
            const memoryLine = document.getElementById('memory-line');
            
            if (memoryChartData.length < 2) return;
            
            const maxMemory = Math.max(...memoryChartData.map(d => d.memory));
            const containerHeight = chartContainer.offsetHeight;
            
            // Create SVG path for the line
            const pathData = memoryChartData.map((data, index) => {
                const x = (index / (memoryChartData.length - 1)) * 100;
                const y = 100 - (data.memory / maxMemory) * 100;
                return `${index === 0 ? 'M' : 'L'} ${x}% ${y}%`;
            }).join(' ');
            
            memoryLine.style.background = 'none';
            memoryLine.style.clipPath = `path('${pathData}')`;
        }
        
        // Global functions for testing
        window.createInstance = function() {
            const container = document.getElementById('instance-container');
            const instanceId = ++instanceCounter;
            
            const instanceCard = document.createElement('div');
            instanceCard.className = 'instance-card';
            instanceCard.id = `instance-${instanceId}`;
            
            instanceCard.innerHTML = `
                <h4>üñºÔ∏è Instance ${instanceId}</h4>
                <nxa-image data-features="slideshow arrows indicators fullsize" interval="${2000 + Math.random() * 3000}" debug="true">
                    <img src="https://picsum.photos/300/200?random=${instanceId * 100}" alt="Test Image ${instanceId}" data-caption="Performance test image">
                    <img src="https://picsum.photos/300/200?random=${instanceId * 100 + 1}" alt="Test Image ${instanceId + 1}" data-caption="Performance test image">
                </nxa-image>
                <button class="btn warning" onclick="removeInstance(${instanceId})">üóëÔ∏è Remove</button>
            `;
            
            container.appendChild(instanceCard);
            createdInstances.push(instanceId);
            
            addResult(`‚úÖ Created Instance ${instanceId}`, 'success');
            updatePerformanceMetrics();
        };
        
        window.createMultipleInstances = function(count) {
            for (let i = 0; i < count; i++) {
                setTimeout(() => window.createInstance(), i * 100);
            }
        };
        
        window.removeInstance = function(instanceId) {
            const instanceCard = document.getElementById(`instance-${instanceId}`);
            if (instanceCard) {
                instanceCard.remove();
                createdInstances = createdInstances.filter(id => id !== instanceId);
                addResult(`üóëÔ∏è Removed Instance ${instanceId}`, 'info');
                updatePerformanceMetrics();
            }
        };
        
        window.removeAllInstances = function() {
            createdInstances.forEach(id => window.removeInstance(id));
            addResult('üóëÔ∏è Removed all instances', 'warning');
        };
        
        window.startStressTest = function() {
            if (stressTestActive) return;
            
            stressTestActive = true;
            addResult('üöÄ Starting stress test...', 'info');
            
            // Create instances rapidly
            const stressInterval = setInterval(() => {
                if (!stressTestActive) {
                    clearInterval(stressInterval);
                    return;
                }
                
                window.createInstance();
                
                // Stop if we have too many instances
                if (createdInstances.length >= 20) {
                    addResult('‚ö†Ô∏è Stress test limit reached (20 instances)', 'warning');
                    window.stopStressTest();
                }
            }, 500);
        };
        
        window.pauseStressTest = function() {
            stressTestActive = false;
            addResult('‚è∏Ô∏è Stress test paused', 'warning');
        };
        
        window.stopStressTest = function() {
            stressTestActive = false;
            addResult('‚èπÔ∏è Stress test stopped', 'info');
        };
        
        window.startPerformanceMonitoring = function() {
            if (monitoringActive) return;
            
            monitoringActive = true;
            performanceInterval = setInterval(updatePerformanceMetrics, 1000);
            addResult('üìà Performance monitoring started', 'success');
        };
        
        window.stopPerformanceMonitoring = function() {
            if (!monitoringActive) return;
            
            monitoringActive = false;
            if (performanceInterval) {
                clearInterval(performanceInterval);
            }
            addResult('üìâ Performance monitoring stopped', 'warning');
        };
        
        window.exportPerformanceData = function() {
            const dataStr = JSON.stringify(performanceData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'performance-data.json';
            link.click();
            URL.revokeObjectURL(url);
            
            addResult('üíæ Performance data exported', 'success');
        };
        
        window.forceGarbageCollection = function() {
            addResult('üóëÔ∏è Forcing garbage collection...', 'info');
            // Note: This is a placeholder - actual GC control requires specific browser APIs
            addResult('üí° Garbage collection triggered (if supported)', 'info');
        };
        
        window.checkMemoryLeaks = function() {
            addResult('üîç Checking for memory leaks...', 'info');
            
            const instances = document.querySelectorAll('nxa-image');
            const domNodes = document.querySelectorAll('*').length;
            
            if (domNodes > 10000) {
                addResult('‚ö†Ô∏è High DOM node count detected', 'warning');
            } else {
                addResult('‚úÖ DOM node count within normal range', 'success');
            }
            
            if (instances.length > 0) {
                addResult(`‚úÖ ${instances.length} instances properly managed`, 'success');
            }
        };
        
        window.cleanupResources = function() {
            addResult('üßπ Cleaning up resources...', 'info');
            
            // Clear any intervals
            if (performanceInterval) {
                clearInterval(performanceInterval);
                performanceInterval = null;
            }
            
            // Reset counters
            instanceCounter = 0;
            createdInstances = [];
            memoryChartData = [];
            
            addResult('‚úÖ Resources cleaned up', 'success');
        };
        
        window.showConsoleOutput = function() {
            const consoleDiv = document.getElementById('console-output');
            consoleDiv.style.display = consoleDiv.style.display === 'none' ? 'block' : 'none';
        };
        
        window.clearResults = function() {
            document.getElementById('test-results').innerHTML = `
                <p>Click the test buttons above to start performance testing.</p>
            `;
            consoleOutput = [];
            updateConsoleOutput();
        };
        
        window.runFullPerformanceTest = function() {
            addResult('üß™ Running complete performance test suite...', 'info');
            
            // Test 1: Baseline performance
            addResult('üìä Measuring baseline performance...', 'info');
            
            // Test 2: Instance creation performance
            const startTime = performance.now();
            window.createInstance();
            const endTime = performance.now();
            const creationTime = endTime - startTime;
            
            addResult(`‚úÖ Instance creation time: ${creationTime.toFixed(2)}ms`, 'success');
            
            // Test 3: Memory usage
            addResult('üíæ Checking memory usage...', 'info');
            window.checkMemoryLeaks();
            
            // Test 4: Stress test
            addResult('üöÄ Running stress test...', 'info');
            window.startStressTest();
            
            setTimeout(() => {
                window.stopStressTest();
                addResult('üéâ Full performance test completed!', 'success');
            }, 10000);
        };
        
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const resultElement = document.createElement('div');
            resultElement.className = `result-item result-${type}`;
            resultElement.innerHTML = message;
            resultsDiv.appendChild(resultElement);
        }
        
        function updateConsoleOutput() {
            const consoleContent = document.getElementById('console-content');
            if (consoleContent) {
                consoleContent.innerHTML = consoleOutput
                    .slice(-30) // Show last 30 entries
                    .map(entry => `<div>[${entry.timestamp}] ${entry.message}</div>`)
                    .join('');
                consoleContent.scrollTop = consoleContent.scrollHeight;
            }
        }
    </script>
</body>
</html>
